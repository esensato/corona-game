<html>

        <meta charset="UTF-8">

<head>
    <title>Corona Game</title>

    <script>

        var info = '';

        const BOTAO_DIREITA = 39;
        const BOTAO_ESQUERDA = 37;
        const BOTAO_CIMA = 38;
        const BOTAO_BAIXO = 40;
        const PARADO = 32;
        const TAMANHO_BLOCO = 64;
        const LARGURA_TABULEIRO = 19;
        const ALTURA_TABULEIRO = 9;
        const TOTAL_IMAGEM = 18;

        var posCorona = [{pos: {x: 4 * TAMANHO_BLOCO, y:3 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false},
                         {pos: {x: 4 * TAMANHO_BLOCO, y:3 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false},
                         {pos: {x: 4 * TAMANHO_BLOCO, y:3 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false}];

        var posVelhinho = [{pos: {x: 4 * TAMANHO_BLOCO, y:3 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false},
                         {pos: {x: 4 * TAMANHO_BLOCO, y:3 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false},
                         {pos: {x: 4 * TAMANHO_BLOCO, y:3 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false}];

        var tabuleiro = [ "calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","asfaltoh","asfaltoh","asfaltoh","asfaltoe","casa","asfaltod","asfaltoh","asfaltoh","asfaltoh","asfaltoe","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","asfaltov","grama","asfaltov","calcada","calcada","calcada","asfaltov","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","asfaltod","asfaltoh","asfaltobe","grama","asfaltov","calcada","calcada","calcada","asfaltov","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","asfaltov","grama","grama","grama","asfaltov","calcada","calcada","calcada","asfaltov","calcada","calcada","calcada","asfaltod","asfaltoh","asfaltoh","calcada","calcada","calcada","calcada","asfaltobd","asfaltoh","asfaltoe","grama","asfaltobd","asfaltoe","calcada","calcada","asfaltobd","asfaltoh","asfaltoh","asfaltoh","asfaltobe","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","asfaltov","grama","grama","asfaltov","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","asfaltobd","asfaltoh","asfaltoh","asfaltobe","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada","calcada"];

        var imgBuffer = new Map();

        var carroX = 64;
        var carroY = 64;
        var imagemCarro = "carrod";

        var direcaoCarro = PARADO;

        var imgFundo = null;

        var exibeSplash = true;
        var coronaSplashX = 0;
        var coronaSplashY = 0;

        function carregarImagem(nome, callback) {

            if (!imgBuffer.has(nome)) {

                var img = new Image(); 
                img.src =  'img/' + nome + '.png'; 
                img.onload = function() {
                    imgBuffer.set(nome, img);
                    console.log('Carregado: ' + img.src + ", " + imgBuffer.size);
                    if(imgBuffer.size == TOTAL_IMAGEM){
                        callback(imgBuffer.size);
                    }      
                }

            }

        }

        function carregarBufferImagens(callback) {

            for (var i = 0; i < tabuleiro.length; i++) {

                if (imgBuffer.get(tabuleiro[i]) == null) {
                    carregarImagem(tabuleiro[i], (total) => {console.log(total); callback();});
                }

            }

            carregarImagem('carroc', (total) => {console.log(total); callback();});
            carregarImagem('carrod', (total) => {console.log(total); callback();});
            carregarImagem('carroe', (total) => {console.log(total); callback();});
            carregarImagem('carrob', (total) => {console.log(total); callback();});
            carregarImagem('corona', (total) => {console.log(total); callback();});
            carregarImagem('explosao', (total) => {console.log(total); callback();});
            carregarImagem('titio', (total) => {console.log(total); callback();});
            carregarImagem('titio2', (total) => {console.log(total); callback();});
            carregarImagem('casa', (total) => {console.log(total); callback();});
            carregarImagem('splash', (total) => {console.log(total); callback();});

            console.log('Buffer de imagem carregado');

        }

        function criaImagemFundo() {

            var offCanvas = document.createElement('canvas');
            var ctxOffCanvas = offCanvas.getContext('2d');

            offCanvas.width = TAMANHO_BLOCO * LARGURA_TABULEIRO;
            offCanvas.height = TAMANHO_BLOCO * ALTURA_TABULEIRO;

            ctxOffCanvas.width = TAMANHO_BLOCO * LARGURA_TABULEIRO;
            ctxOffCanvas.height = TAMANHO_BLOCO * ALTURA_TABULEIRO;
            
            var linha = 0;
            var coluna = 0;

            for (var i = 0; i < tabuleiro.length; i++) {

                var img = imgBuffer.get(tabuleiro[i]);
                ctxOffCanvas.drawImage(img, coluna, linha);
                coluna += TAMANHO_BLOCO;
                if (LARGURA_TABULEIRO == (coluna / TAMANHO_BLOCO)) {
                    coluna = 0;
                    linha += TAMANHO_BLOCO;
                }

            }

            var meioX = (TAMANHO_BLOCO * LARGURA_TABULEIRO) / 2;
            var meioY = (TAMANHO_BLOCO * ALTURA_TABULEIRO) / 2;

            if (exibeSplash) {
                ctxOffCanvas.drawImage(imgBuffer.get('splash'), meioX - ((imgBuffer.get('splash').width / 2)), meioY - ((imgBuffer.get('splash').height / 2)));
                coronaSplashX = meioX;
                coronaSplashY = meioY;
            }

            imgBuffer.set('fundo', offCanvas);
            console.log('Imagem de fundo criada');

        }

        function direcionaCorona() {
            posCorona.forEach((corona) => {
                if (corona.novoSorteio) {
                    var direcoes = [];
                    var tabuleiroBaixo = getItemTabuleiro({x:corona.pos.x, y:corona.pos.y});
                    var tabuleiroFrente = getItemTabuleiro({x:corona.pos.x, y:corona.pos.y});
                    var tabuleiroTraseira = getItemTabuleiro({x:corona.pos.x, y:corona.pos.y});
                    var tabuleiroCima = getItemTabuleiro({x:corona.pos.x, y:corona.pos.y});

                    if (tabuleiroCima.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_CIMA);
                    }
                    if (tabuleiroBaixo.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_BAIXO);
                    }
                    if (tabuleiroFrente.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_DIREITA);
                    }
                    if (tabuleiroTraseira.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_ESQUERDA);
                    }

                    corona.novoSorteio = false;
                    corona.direcao = direcoes[getRandomIntInclusive(0, direcoes.length - 1)];

                }
            });
        }

        function moveCorona() {

            posCorona.forEach((corona) => {

                var tabuleiroBaixo = getItemTabuleiro({x: corona.pos.x + (TAMANHO_BLOCO / 2), y: corona.pos.y + TAMANHO_BLOCO});
                var tabuleiroFrente = getItemTabuleiro( {x: corona.pos.x + TAMANHO_BLOCO, y: corona.pos.y + (TAMANHO_BLOCO / 2)});
                var tabuleiroTraseira = getItemTabuleiro({x: corona.pos.x - 1, y: corona.pos.y + (TAMANHO_BLOCO / 2)});
                var tabuleiroCima = getItemTabuleiro({x: corona.pos.x + (TAMANHO_BLOCO / 2), y: corona.pos.y - 1});
                
                if (corona.direcao == BOTAO_CIMA) {
                        if (!tabuleiroCima.item.startsWith('asfalto')){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.y -= 1;
                        }
                    } else if (corona.direcao == BOTAO_BAIXO) {
                        if (!tabuleiroBaixo.item.startsWith('asfalto')){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.y += 1;
                        }                  
                    } else if (corona.direcao == BOTAO_ESQUERDA) {
                        if (!tabuleiroTraseira.item.startsWith('asfalto')){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.x -= 1;
                        }
                    } else if (corona.direcao == BOTAO_DIREITA) {
                        if (!tabuleiroFrente.item.startsWith('asfalto')){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.x += 1;
                        }

                    }
            });
        }

        // Movimento velhinos

        function direcionaVelhinho() {
            posVelhinho.forEach((velhinho) => {
                if (velhinho.novoSorteio) {
                    var direcoes = [];
                    var tabuleiroBaixo = getItemTabuleiro({x:velhinho.pos.x, y:velhinho.pos.y});
                    var tabuleiroFrente = getItemTabuleiro({x:velhinho.pos.x, y:velhinho.pos.y});
                    var tabuleiroTraseira = getItemTabuleiro({x:velhinho.pos.x, y:velhinho.pos.y});
                    var tabuleiroCima = getItemTabuleiro({x:velhinho.pos.x, y:velhinho.pos.y});

                    if (tabuleiroCima.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_CIMA);
                    }
                    if (tabuleiroBaixo.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_BAIXO);
                    }
                    if (tabuleiroFrente.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_DIREITA);
                    }
                    if (tabuleiroTraseira.item.startsWith('asfalto')){
                        direcoes.push(BOTAO_ESQUERDA);
                    }

                    velhinho.novoSorteio = false;
                    velhinho.direcao = direcoes[getRandomIntInclusive(0, direcoes.length - 1)];

                }
            });
        }

        function moveVelhinho() {

            posVelhinho.forEach((velhinho) => {

                var tabuleiroBaixo = getItemTabuleiro({x: velhinho.pos.x + (TAMANHO_BLOCO / 2), y: velhinho.pos.y + TAMANHO_BLOCO});
                var tabuleiroFrente = getItemTabuleiro( {x: velhinho.pos.x + TAMANHO_BLOCO, y: velhinho.pos.y + (TAMANHO_BLOCO / 2)});
                var tabuleiroTraseira = getItemTabuleiro({x: velhinho.pos.x - 1, y: velhinho.pos.y + (TAMANHO_BLOCO / 2)});
                var tabuleiroCima = getItemTabuleiro({x: velhinho.pos.x + (TAMANHO_BLOCO / 2), y: velhinho.pos.y - 1});
                
                if (velhinho.direcao == BOTAO_CIMA) {
                        if (!tabuleiroCima.item.startsWith('asfalto')){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.y -= 1;
                        }
                    } else if (velhinho.direcao == BOTAO_BAIXO) {
                        if (!tabuleiroBaixo.item.startsWith('asfalto')){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.y += 1;
                        }                  
                    } else if (velhinho.direcao == BOTAO_ESQUERDA) {
                        if (!tabuleiroTraseira.item.startsWith('asfalto')){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.x -= 1;
                        }
                    } else if (velhinho.direcao == BOTAO_DIREITA) {
                        if (!tabuleiroFrente.item.startsWith('asfalto')){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.x += 1;
                        }

                    }
            });
        }

        function animaCarro() {

            var offCanvas = document.getElementById('tabuleiro');
            var ctxOffCanvas = offCanvas.getContext("2d");

            if (temCorona()) {

                imagemCarro = "explosao";
                direcaoCarro = PARADO;

            }

            if (direcaoCarro != PARADO) {

                var tabuleiroBaixo = getItemTabuleiro(getCarroPontoBaixo());
                var tabuleiroFrente = getItemTabuleiro(getCarroPontoFrente());
                var tabuleiroTraseira = getItemTabuleiro(getCarroPontoTraseira());
                var tabuleiroCima = getItemTabuleiro(getCarroPontoCima());

                if (temCorona()) {

                    imagemCarro = "explosao";
                    direcaoCarro = PARADO;

                }

                if (direcaoCarro == BOTAO_CIMA) {
                    imagemCarro = "carroc";
                    if (!tabuleiroCima.item.startsWith('asfalto')){
                        direcaoCarro = PARADO;
                    } else {
                        carroY -= 1;
                    }
                } else if (direcaoCarro == BOTAO_BAIXO) {
                    imagemCarro = "carrob";
                    if (!tabuleiroBaixo.item.startsWith('asfalto')){
                        direcaoCarro = PARADO;
                    } else {
                        carroY += 1;
                    }                  
                } else if (direcaoCarro == BOTAO_ESQUERDA) {
                    imagemCarro = "carroe";
                    if (!tabuleiroTraseira.item.startsWith('asfalto')){
                        direcaoCarro = PARADO;
                    } else {
                        carroX -= 1;
                    }
                } else if (direcaoCarro == BOTAO_DIREITA) {
                    imagemCarro = "carrod";
                    if (!tabuleiroFrente.item.startsWith('asfalto')){
                        direcaoCarro = PARADO;
                    } else {
                        carroX += 1;
                    }

                }

            }

            ctxOffCanvas.drawImage(imgBuffer.get('fundo'), 0, 0);

            ctxOffCanvas.drawImage(imgBuffer.get(imagemCarro), carroX, carroY);

            posCorona.forEach((item) => {
                ctxOffCanvas.drawImage(imgBuffer.get('corona'), item.pos.x, item.pos.y);
            });

            posVelhinho.forEach((item) => {
                ctxOffCanvas.drawImage(imgBuffer.get('titio'), item.pos.x, item.pos.y);
            });

            direcionaCorona();
            moveCorona();
            direcionaVelhinho();
            moveVelhinho();
            printInfo();

        }

        function podeMudarPosicao() {

            if (carroX % TAMANHO_BLOCO == 0 && carroY % TAMANHO_BLOCO == 0) {
                return true;
            } else {
                return false;
            }

        }

        function getCarroPontoBaixo() {
            return {x: carroX + (TAMANHO_BLOCO / 2), y: carroY + TAMANHO_BLOCO};
        }

        function getCarroPontoFrente() {
            return {x: carroX + TAMANHO_BLOCO, y: carroY + (TAMANHO_BLOCO / 2)};
        }

        function getCarroPontoTraseira() {
            return {x: carroX - 1, y: carroY + (TAMANHO_BLOCO / 2)};
        }

        function getCarroPontoCima() {
            return {x: carroX + (TAMANHO_BLOCO / 2), y: carroY - 1};
        }

        function getItemTabuleiro(pos) {

            var xTabuleiro = parseInt(pos.x / TAMANHO_BLOCO);
            var yTabuleiro = parseInt(pos.y / TAMANHO_BLOCO);
            var posTabuleiro = LARGURA_TABULEIRO * yTabuleiro + xTabuleiro;
            return {x: xTabuleiro, y: yTabuleiro, item: tabuleiro[posTabuleiro]};
        }

        function getPosCarroTabuleiro() {
            return {x: parseInt((carroX + TAMANHO_BLOCO / 2) / TAMANHO_BLOCO), y: parseInt((carroY + TAMANHO_BLOCO / 2) / TAMANHO_BLOCO)};
        }

        function getPosTabuleiro(x, y) {
            return {x: parseInt((x + TAMANHO_BLOCO / 2)/ TAMANHO_BLOCO), y: parseInt((y + TAMANHO_BLOCO / 2) / TAMANHO_BLOCO)};
        }

        function printInfo() {
            /**
            var posCarroTabuleiro = getPosCarroTabuleiro();

            var tabuleiroBaixo = getItemTabuleiro(getCarroPontoBaixo());
            var tabuleiroFrente = getItemTabuleiro(getCarroPontoFrente());
            var tabuleiroTraseira = getItemTabuleiro(getCarroPontoTraseira());
            var tabuleiroCima = getItemTabuleiro(getCarroPontoCima());

            var info = 'X = ' + carroX + 'Y = ' + carroY + '<br>';
            info += 'posCarroTabuleiro = ' + JSON.stringify(posCarroTabuleiro) + '<br>';
            info += 'tabuleiroBaixo = ' + JSON.stringify(tabuleiroBaixo) + '<br>';
            info += 'tabuleiroFrente = ' + JSON.stringify(tabuleiroFrente) + '<br>';
            info += 'tabuleiroTraseira = ' + JSON.stringify(tabuleiroTraseira) + '<br>';
            info += 'tabuleiroCima = ' + JSON.stringify(tabuleiroCima) + '<br>';
            info += 'tabuleiroCima = ' + JSON.stringify(tabuleiroCima) + '<br>';

            posCorona.forEach((item) => {
                if (posCarroTabuleiro.x == item.x && posCarroTabuleiro.y == item.y){
                    info += 'VIRUSSSSS ' + '<br>';
                }
            });

            info += 'temCorona = ' + temCorona() + '<br>';
            **/

            //info += JSON.stringify(posCorona) + '<br>';
            document.getElementById('info').innerHTML = info;
            info = '';
        }

        function temCorona() {

            var posCarroTabuleiro = getPosCarroTabuleiro();
            var resultado = false;
            posCorona.forEach((item) => {

                var posCoronaTabuleiro = getPosTabuleiro(item.pos.x, item.pos.y);
                info += JSON.stringify(posCoronaTabuleiro);
                if (posCarroTabuleiro.x == posCoronaTabuleiro.x && posCarroTabuleiro.y == posCoronaTabuleiro.y){
                    resultado = true;
                    return;
                }
            });
            
            return resultado;

        }

        function animacao() {

            window.setInterval(function(){
                animaCarro();
            }, 10);

        }

        function eventoTeclado(event) {

            var tabuleiroBaixo = getItemTabuleiro(getCarroPontoBaixo());
            var tabuleiroFrente = getItemTabuleiro(getCarroPontoFrente());
            var tabuleiroTraseira = getItemTabuleiro(getCarroPontoTraseira());
            var tabuleiroCima = getItemTabuleiro(getCarroPontoCima());

            if (event.keyCode == BOTAO_BAIXO && 
                (direcaoCarro == BOTAO_BAIXO || direcaoCarro == BOTAO_CIMA || direcaoCarro == PARADO) &&
                tabuleiroBaixo.item.startsWith('asfalto')) {
                direcaoCarro = BOTAO_BAIXO;
            } else if (event.keyCode == BOTAO_CIMA && 
                      (direcaoCarro == BOTAO_BAIXO || direcaoCarro == BOTAO_CIMA || direcaoCarro == PARADO) &&
                       tabuleiroCima.item.startsWith('asfalto')) {
                direcaoCarro = BOTAO_CIMA;
            } else if (event.keyCode == BOTAO_ESQUERDA && 
                (direcaoCarro == BOTAO_ESQUERDA || direcaoCarro == BOTAO_DIREITA || direcaoCarro == PARADO) &&
                tabuleiroTraseira.item.startsWith('asfalto')) {
                direcaoCarro = BOTAO_ESQUERDA;
            } else if (event.keyCode == BOTAO_DIREITA && 
                (direcaoCarro == BOTAO_ESQUERDA || direcaoCarro == BOTAO_DIREITA || direcaoCarro == PARADO) &&
                tabuleiroFrente.item.startsWith('asfalto')) {
                direcaoCarro = BOTAO_DIREITA;
            }

        }

        function splash() {

           var offCanvas = document.getElementById('tabuleiro');
           var ctxOffCanvas = offCanvas.getContext("2d");
            ctxOffCanvas.drawImage(imgBuffer.get('fundo'), 0, 0);
            console.log('Splash on');

        }

        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function inicio(event) {
            var x = event.clientX;
            var y = event.clientY;

            if (x >= 360 && x <= 490 && y >= 370 && y <= 500) {
                exibeSplash = false;
                criaImagemFundo();
                animacao();
            }

        }

    </script>

</head>

<body onkeydown="eventoTeclado(event);" onclick="inicio(event)">

    <div>

        <canvas id="tabuleiro" style="border: solid 1px">
        </canvas>

    </div>

<div id="info"></div>

<script>
        document.getElementById('tabuleiro').width = LARGURA_TABULEIRO * TAMANHO_BLOCO;
        document.getElementById('tabuleiro').height = ALTURA_TABULEIRO * TAMANHO_BLOCO;

        carregarBufferImagens(()=>{
            console.log('OK');
            criaImagemFundo();
            splash();
            });

</script>

</body>
</html>