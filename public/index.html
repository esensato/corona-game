<html>

        <meta charset="UTF-8">

<head>
    <title>Corona Game</title>

    <script>

        var info = '';

        const BOTAO_DIREITA = 39;
        const BOTAO_ESQUERDA = 37;
        const BOTAO_CIMA = 38;
        const BOTAO_BAIXO = 40;
        const PARADO = 32;
        const TAMANHO_BLOCO = 64;
        const MEIO_BLOCO = TAMANHO_BLOCO / 2;
        const LARGURA_TABULEIRO = 19;
        const ALTURA_TABULEIRO = 9;
        const PESO_DIRECAO = 5;
        const INTERVALO_PISCA = 30;
        var imagens = [ 'calcada', 
                        'asfaltod',
                        'asfaltoe',
                        'asfaltoh',
                        'asfaltov',
                        'asfaltobd',
                        'asfaltotb',
                        'asfaltotc',
                        'asfaltobe',
                        'grama',
                        'casa',
                        'carrovc',
                        'carrovd',
                        'carrove',
                        'carrovb',
                        'carrorc',
                        'carrord',
                        'carrore',
                        'carrorb', 
                        'corona',
                        'explosao',
                        'titio',
                        'titio2',
                        'splash'];

        const TOTAL_IMAGEM = imagens.length;

        // carro representa o carro do jogador que recolhe os velhinhos
        var carro = {pos: {x: 0, y: 0}, imagem: "carrovd", direcao: PARADO, direcaoDesejada: PARADO, ultimaDirecao: PARADO, pegouVelhinho: false, pisca: 0, mudouDirecao: function() {return this.direcao != this.ultimaDirecao}};

        var posCorona = [{pos: {x: 11 * TAMANHO_BLOCO, y:4 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:0, baixo: 0, direita: 0, esquerda: 0}];

        var posVelhinho = [{pos: {x: 4 * TAMANHO_BLOCO, y:4 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false},
                         {pos: {x: 4 * TAMANHO_BLOCO, y:4 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false},
                         {pos: {x: 10 * TAMANHO_BLOCO, y:7 * TAMANHO_BLOCO}, novoSorteio: true, direcao: BOTAO_BAIXO, cima:false, baixo: false, direita: false, esquerda: false}];

        var tabuleiros = [{criador: "Bruninho", 
                           mapa:[ "asfaltod", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoe", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "asfaltov", "grama", "asfaltov", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "asfaltov", "grama", "asfaltov", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "asfaltobd", "asfaltotb", "asfaltobe", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "grama", "asfaltov", "casa", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltotc", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotc", "asfaltoe", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "asfaltov", "asfaltov", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "asfaltov", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltotc", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotc", "asfaltoh", "asfaltoh", "asfaltotc", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltobe"]},
                          {criador:"Cec√≠lia", 
                           mapa:[ "asfaltod", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoe", "grama", "asfaltod", "asfaltoh", "asfaltoh", "asfaltoe", "asfaltov", "grama", "grama", "grama", "casa", "asfaltov", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "asfaltov", "grama", "asfaltov", "grama", "grama", "asfaltov", "asfaltov", "grama", "grama", "grama", "grama", "asfaltobd", "asfaltoh", "asfaltoe", "grama", "grama", "asfaltod", "asfaltoh", "asfaltoh", "asfaltobe", "grama", "asfaltov", "grama", "grama", "asfaltov", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltoe", "grama", "grama", "grama", "asfaltov", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "asfaltov", "grama", "grama", "asfaltov", "grama", "grama", "casa", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "asfaltov", "casa", "grama", "grama", "grama", "asfaltov", "grama", "grama", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltobe", "grama", "grama", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "asfaltobd", "asfaltoh", "asfaltoe", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "casa", "asfaltov", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotc", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltobe"]},
                          {criador:"Edson", 
                           mapa:[ "asfaltod", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoe", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "asfaltov", "calcada", "calcada", "calcada", "grama", "grama", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "grama", "grama", "calcada", "asfaltov", "asfaltov", "calcada", "calcada", "calcada", "grama", "grama", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "grama", "grama", "calcada", "asfaltov", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "grama", "grama", "grama", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "grama", "casa", "grama", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltobe"]},
                          {criador:"Edson", 
                           mapa:[ "asfaltod", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoe", "casa", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", 
                            "asfaltov", "calcada", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltod", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoe", "calcada", "asfaltov", "calcada", "asfaltod", "asfaltoh", "asfaltobe", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "calcada", "asfaltov", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "calcada", "asfaltov", "calcada", "asfaltobd", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotb", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltobe", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltov", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "asfaltobd", "asfaltoe", "asfaltov", "grama", "grama", "grama", "grama", "grama", "grama", "asfaltov", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "grama", "asfaltov", "asfaltov", "grama", "asfaltod", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltotc", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoh", "asfaltoe", "grama", "grama", "grama", "grama", "asfaltov", "asfaltobd", "asfaltoh", "asfaltobe", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada", "calcada","calcada","asfaltobd","asfaltoh","asfaltoh","asfaltoh","asfaltoh","asfaltobe"]}];

        var tabuleiro = {};
        var tabuleirosSorteio = [];
        var imgBuffer = new Map();

        var imgFundo = null;

        var exibeSplash = true;
        var coronaSplashX = 0;
        var coronaSplashY = 0;
        
        function iniciaTabuleiroSorteio() {
            for (var i = 0; i < tabuleiros.length; i++) {
                tabuleirosSorteio[i] = i;
            }
        }

        function sorteiaTabuleiro() {

            if (tabuleirosSorteio.length == 0) {
                iniciaTabuleiroSorteio();
            }

            var tabuleiroId = getRandomIntInclusive(0, tabuleirosSorteio.length - 1);
            tabuleiro = tabuleiros[tabuleiroId];
            removeElementoArray(tabuleirosSorteio, tabuleiroId);
            document.getElementById('autormapa').innerHTML = 'Mapa criado por: ' + tabuleiro.criador;

        }

        function carregarImagem(nome, callback) {

            if (!imgBuffer.has(nome)) {

                var img = new Image(); 
                img.src =  'img/' + nome + '.png'; 
                img.onload = function() {
                    imgBuffer.set(nome, img);
                    console.log('Carregado: ' + img.src + ", " + imgBuffer.size);
                    if(imgBuffer.size == TOTAL_IMAGEM){
                        callback(imgBuffer.size);
                    }      
                }

            }

        }

        function carregarBufferImagens(callback) {

            for (var i = 0; i < tabuleiro.mapa.length; i++) {

                if (imgBuffer.get(imagens[i]) == null) {
                    carregarImagem(imagens[i], (total) => {console.log(total); callback();});
                }

            }

            console.log('Buffer de imagem carregado');

        }

        function criaImagemFundo() {

            var offCanvas = document.createElement('canvas');
            var ctxOffCanvas = offCanvas.getContext('2d');

            offCanvas.width = TAMANHO_BLOCO * LARGURA_TABULEIRO;
            offCanvas.height = TAMANHO_BLOCO * ALTURA_TABULEIRO;

            ctxOffCanvas.width = TAMANHO_BLOCO * LARGURA_TABULEIRO;
            ctxOffCanvas.height = TAMANHO_BLOCO * ALTURA_TABULEIRO;
            
            var linha = 0;
            var coluna = 0;

            for (var i = 0; i < tabuleiro.mapa.length; i++) {

                var img = imgBuffer.get(tabuleiro.mapa[i]);
                ctxOffCanvas.drawImage(img, coluna, linha);
                coluna += TAMANHO_BLOCO;
                if (LARGURA_TABULEIRO == (coluna / TAMANHO_BLOCO)) {
                    coluna = 0;
                    linha += TAMANHO_BLOCO;
                }

            }

            var meioX = (TAMANHO_BLOCO * LARGURA_TABULEIRO) / 2;
            var meioY = (TAMANHO_BLOCO * ALTURA_TABULEIRO) / 2;

            if (exibeSplash) {
                ctxOffCanvas.drawImage(imgBuffer.get('splash'), meioX - ((imgBuffer.get('splash').width / 2)), meioY - ((imgBuffer.get('splash').height / 2)));
                coronaSplashX = meioX;
                coronaSplashY = meioY;
            }

            imgBuffer.set('fundo', offCanvas);
            console.log('Imagem de fundo criada');

        }

        function moveCorona() {

            posCorona.forEach((corona) => {

                //obtem itens no entorno do corona (cima, baixo, esquerda e direita)
                var entorno = getItensEntorno(corona);
                
                if (corona.direcao == BOTAO_CIMA) {
                        if (!entorno.cima.startsWith('asfalto') && (corona.pos.x % TAMANHO_BLOCO == 0) && (corona.pos.y % TAMANHO_BLOCO == 0)){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.y -= 1;
                        }
                    } else if (corona.direcao == BOTAO_BAIXO ) {
                        if (!entorno.baixo.startsWith('asfalto') && (corona.pos.x % TAMANHO_BLOCO == 0) && (corona.pos.y % TAMANHO_BLOCO == 0)){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.y += 1;
                        }                  
                    } else if (corona.direcao == BOTAO_ESQUERDA) {
                        if (!entorno.esquerda.startsWith('asfalto') && (corona.pos.x % TAMANHO_BLOCO == 0) && (corona.pos.y % TAMANHO_BLOCO == 0)){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.x -= 1;
                        }
                    } else if (corona.direcao == BOTAO_DIREITA) {
                        if (!entorno.direita.startsWith('asfalto') && (corona.pos.x % TAMANHO_BLOCO == 0) && (corona.pos.y % TAMANHO_BLOCO == 0)){
                            corona.direcao = PARADO;
                            corona.novoSorteio = true;
                        } else {
                            corona.pos.x += 1;
                        }

                    }
            });
            }

        function direcionaCorona() {
            posCorona.forEach((corona) => {
                if (corona.novoSorteio) {
                    var direcoes = [];

                    //obtem itens no entorno do velhinho (cima, baixo, esquerda e direita)
                    var entorno = getItensEntorno(corona);

                    if (entorno.cima.startsWith('asfalto')){
                        direcoes.push(BOTAO_CIMA);
                    }
                    if (entorno.baixo.startsWith('asfalto')){
                        direcoes.push(BOTAO_BAIXO);
                    }
                    if (entorno.direita.startsWith('asfalto')){
                        direcoes.push(BOTAO_DIREITA);
                    }
                    if (entorno.esquerda.startsWith('asfalto')){
                        direcoes.push(BOTAO_ESQUERDA);
                    }

                    if (direcoes.length > 1) {
                        // apos uma quantidade de sorteios (PESO_DIRECAO)
                        // remove das possiveis direcoes a que foi mais sorteada e zera os contadores
                        var tot = (corona.cima + corona.baixo + corona.esquerda + corona.direita);
                        if (tot >= PESO_DIRECAO) {

                            var maiorQtdeSorteada = 0;
                            var direcaoMaisSorteada = PARADO;

                            if (corona.cima > maiorQtdeSorteada) {
                                maiorQtdeSorteada = corona.cima;
                                direcaoMaisSorteada = BOTAO_CIMA;
                            }
                            if (corona.baixo > maiorQtdeSorteada) {
                                maiorQtdeSorteada = corona.baixo;
                                direcaoMaisSorteada = BOTAO_BAIXO;
                            }
                            if (corona.direita > maiorQtdeSorteada) {
                                maiorQtdeSorteada = corona.direita;
                                direcaoMaisSorteada = BOTAO_DIREITA;
                            }
                            if (corona.esquerda > maiorQtdeSorteada) {
                                maiorQtdeSorteada = corona.esquerda;
                                direcaoMaisSorteada = BOTAO_ESQUERDA;
                            }

                            // cria um novo array sem a direcao mais sorteada
                            var novoDirecoes = [];
                            for (var i = 0; i < direcoes.length; i++) {
                                if (direcoes[i] != direcaoMaisSorteada){
                                    novoDirecoes.push(direcoes[i]);
                                }
                            }

                            direcoes = novoDirecoes;
                            console.log("REMOVE POSICAO POS = " + direcoes);

                            corona.cima = 0;
                            corona.baixo = 0;
                            corona.esquerda = 0;
                            corona.direita = 0;
                        }
                    }

                    corona.novoSorteio = false;
                    corona.direcao = direcoes[getRandomIntInclusive(0, direcoes.length - 1)];

                    // armazena a estatistica de quanto cada direcao foi sorteada
                    if (corona.direcao == BOTAO_CIMA){
                        corona.cima++;
                    } else if (corona.direcao == BOTAO_BAIXO){
                        corona.baixo++;
                    } else if (corona.direcao == BOTAO_ESQUERDA){
                        corona.esquerda++;
                    } else if (corona.direcao == BOTAO_DIREITA){
                        corona.direita++;
                    }

                }
            });
        }

        function moveVelhinho() {

            posVelhinho.forEach((velhinho) => {

                //obtem itens no entorno do velhinho (cima, baixo, esquerda e direita)
                var entorno = getItensEntorno(velhinho);
                
                if (velhinho.direcao == BOTAO_CIMA) {
                        if (!entorno.cima.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.y -= 1;
                        }
                    } else if (velhinho.direcao == BOTAO_BAIXO ) {
                        if (!entorno.baixo.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.y += 1;
                        }                  
                    } else if (velhinho.direcao == BOTAO_ESQUERDA) {
                        if (!entorno.esquerda.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.x -= 1;
                        }
                    } else if (velhinho.direcao == BOTAO_DIREITA) {
                        if (!entorno.direita.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.x += 1;
                        }

                    }
            });
        }
        // Movimento velhinos
        function direcionaVelhinho() {
            posVelhinho.forEach((velhinho) => {
                if (velhinho.novoSorteio) {
                    var direcoes = [];
                    //obtem itens no entorno do velhinho (cima, baixo, esquerda e direita)
                    var entorno = getItensEntorno(velhinho);

                    if (entorno.cima.startsWith('asfalto')){
                        direcoes.push(BOTAO_CIMA);
                    }
                    if (entorno.baixo.startsWith('asfalto')){
                        direcoes.push(BOTAO_BAIXO);
                    }
                    if (entorno.direita.startsWith('asfalto')){
                        direcoes.push(BOTAO_DIREITA);
                    }
                    if (entorno.esquerda.startsWith('asfalto')){
                        direcoes.push(BOTAO_ESQUERDA);
                    }

                    velhinho.novoSorteio = false;
                    velhinho.direcao = direcoes[getRandomIntInclusive(0, direcoes.length - 1)];

                }
            });
        }

        function moveVelhinho() {

            posVelhinho.forEach((velhinho) => {

                //obtem itens no entorno do velhinho (cima, baixo, esquerda e direita)
                var entorno = getItensEntorno(velhinho);
                
                if (velhinho.direcao == BOTAO_CIMA) {
                        if (!entorno.cima.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.y -= 1;
                        }
                    } else if (velhinho.direcao == BOTAO_BAIXO ) {
                        if (!entorno.baixo.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.y += 1;
                        }                  
                    } else if (velhinho.direcao == BOTAO_ESQUERDA) {
                        if (!entorno.esquerda.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.x -= 1;
                        }
                    } else if (velhinho.direcao == BOTAO_DIREITA) {
                        if (!entorno.direita.startsWith('asfalto') && (velhinho.pos.x % TAMANHO_BLOCO == 0) && (velhinho.pos.y % TAMANHO_BLOCO == 0)){
                            velhinho.direcao = PARADO;
                            velhinho.novoSorteio = true;
                        } else {
                            velhinho.pos.x += 1;
                        }

                    }
            });
        }

        // define qual deve ser a imagem do carro considerando:
        // se pegou um velhinho (deve piscar)
        // direcao na qual o carro se move
        // se foi apanhado por um corona virus (explosao)
        function setImagemCarro() {

            // se mudou a direcao a imagem deve ser alterada
            if (carro.mudouDirecao()) {

                // direcao do carro atual
                if (carro.direcao == BOTAO_CIMA) {
                    carro.imagem = 'carrovc';
                } else if (carro.direcao == BOTAO_DIREITA) {
                    carro.imagem = 'carrovd';
                } else if (carro.direcao == BOTAO_BAIXO) {
                    carro.imagem = 'carrovb';
                } else if (carro.direcao == BOTAO_ESQUERDA) {
                    carro.imagem = 'carrove';
                }
        
            // atualiza a ultima direcao para a atual
                carro.ultimaDirecao = carro.direcao;                
            }

            // se pegou velhinho deve incrementar o contador do pisca (sirene)
            // caso o contador seja igual ao parametro INTERVALO_PISCA ele e reiniciado
            if (carro.pegouVelhinho) {
                carro.pisca++;
                if (carro.pisca >= INTERVALO_PISCA) {
                    carro.pisca = 0;

                    // troca as imagens do carro para efeito de pisca da sirene
                    if (carro.imagem == 'carrovc') {
                        carro.imagem = 'carrorc';
                    } else if (carro.imagem == 'carrovd') {
                        carro.imagem = 'carrord';
                    } else if (carro.imagem == 'carrovb') {
                        carro.imagem = 'carrorb';
                    } else if (carro.imagem == 'carrove') {
                        carro.imagem = 'carrore';
                    } else if (carro.imagem == 'carrorc') {
                        carro.imagem = 'carrovc';
                    } else if (carro.imagem == 'carrord') {
                        carro.imagem = 'carrovd';
                    } else if (carro.imagem == 'carrorb') {
                        carro.imagem = 'carrovb';
                    } else if (carro.imagem == 'carrore') {
                        carro.imagem = 'carrove';
                    }

                }
            }
        }

        function animaCarro() {

            var offCanvas = document.getElementById('tabuleiro');
            var ctxOffCanvas = offCanvas.getContext('2d');

            if (pegouCorona()) {

                carro.imagem = "explosao";
                carro.direcao = PARADO;

            }

            var velhinhoPego = pegouVelhinho();
        
            if (carro.pegouVelhinho) {

                console.log("PEGOU = " + posVelhinho.indexOf(velhinhoPego));
                posVelhinho = removeElementoArray(posVelhinho, posVelhinho.indexOf(velhinhoPego));

            }

            devolveuVelhinho();
                            
            //obtem itens no entorno do carro (cima, baixo, esquerda e direita)
            var entorno = getItensEntorno(carro);

            // se direcao desejada for igual direcao atual - ok!
            // se nao mudar sentido - ok!
            if ((carro.direcaoDesejada == carro.direcao) || 
                (carro.direcaoDesejada == BOTAO_ESQUERDA && carro.direcao == BOTAO_DIREITA) || 
                (carro.direcaoDesejada == BOTAO_CIMA && carro.direcao == BOTAO_BAIXO)) {
                    carro.direcao = carro.direcaoDesejada;
            } else if (((carro.pos.x % TAMANHO_BLOCO) == 0) && (carro.pos.y % TAMANHO_BLOCO) == 0) {

                if (carro.direcaoDesejada == BOTAO_CIMA) {
                    if (entorno.cima.startsWith('asfalto') && carro.pos.y >= 0){
                        carro.direcao = carro.direcaoDesejada;
                    }
                } else if (carro.direcaoDesejada == BOTAO_BAIXO) {
                    if (entorno.baixo.startsWith('asfalto')){
                        carro.direcao = carro.direcaoDesejada;
                    }              
                } else if (carro.direcaoDesejada == BOTAO_ESQUERDA) {
                    if (entorno.esquerda.startsWith('asfalto')){
                        carro.direcao = carro.direcaoDesejada;
                    }
                } else if (carro.direcaoDesejada == BOTAO_DIREITA) {
                    if (entorno.direita.startsWith('asfalto')){
                        carro.direcao = carro.direcaoDesejada;
                    }
                }

            }

            if (carro.direcao != PARADO && (carro.pos.x % TAMANHO_BLOCO == 0) && (carro.pos.y % TAMANHO_BLOCO == 0)) {
                if (carro.direcao == BOTAO_CIMA) {
                    if (!entorno.cima.startsWith('asfalto') || carro.pos.y <= 0){
                        carro.direcao = PARADO;
                    }
                } else if (carro.direcao == BOTAO_BAIXO) {
                    if (!entorno.baixo.startsWith('asfalto')){
                        carro.direcao = PARADO;
                    }              
                } else if (carro.direcao == BOTAO_ESQUERDA) {
                    if (!entorno.esquerda.startsWith('asfalto') || carro.pos.x <= 0){
                        carro.direcao = PARADO;
                    }
                } else if (carro.direcao == BOTAO_DIREITA) {
                    if (!entorno.direita.startsWith('asfalto')){
                        carro.direcao = PARADO;
                    }
                }

            }

            if (carro.direcao != PARADO) {

                // atualiza posicao do carro
                if (carro.direcao == BOTAO_CIMA) {
                    carro.pos.y -= 1;
                } else if (carro.direcao == BOTAO_BAIXO) {
                    carro.pos.y += 1;
                } else if (carro.direcao == BOTAO_ESQUERDA) {
                    carro.pos.x -= 1;
                } else if (carro.direcao == BOTAO_DIREITA) {
                    carro.pos.x += 1;
                }

            }

            ctxOffCanvas.drawImage(imgBuffer.get('fundo'), 0, 0);

            // define qual sera a imagem do carro a ser exibida
            setImagemCarro();
            ctxOffCanvas.drawImage(imgBuffer.get(carro.imagem), carro.pos.x, carro.pos.y);

            posCorona.forEach((item) => {
                ctxOffCanvas.drawImage(imgBuffer.get('corona'), item.pos.x, item.pos.y);
            });

            posVelhinho.forEach((item) => {
                ctxOffCanvas.drawImage(imgBuffer.get('titio'), item.pos.x, item.pos.y);
            });

            direcionaCorona();
            moveCorona();
            direcionaVelhinho();
            moveVelhinho();
            //printInfo();

        }

        function getItensEntorno(elemento) {
            
            var posCima = {x: parseInt((elemento.pos.x / TAMANHO_BLOCO)), y: parseInt((elemento.pos.y) / TAMANHO_BLOCO) - 1};
            var posDireita = {x: parseInt(((elemento.pos.x + TAMANHO_BLOCO)/ TAMANHO_BLOCO)), y: parseInt((elemento.pos.y / TAMANHO_BLOCO))};
            var posBaixo = {x: parseInt((elemento.pos.x / TAMANHO_BLOCO)), y: parseInt(((elemento.pos.y + TAMANHO_BLOCO) / TAMANHO_BLOCO))};
            var posEsquerda = {x: parseInt((elemento.pos.x / TAMANHO_BLOCO)) - 1, y: parseInt((elemento.pos.y / TAMANHO_BLOCO))};

            info += JSON.stringify(elemento) + '<br>';
            info += "C = " + JSON.stringify(posCima);
            info += " D = " + JSON.stringify(posDireita);
            info += " B = " + JSON.stringify(posBaixo);
            info += " E = " + JSON.stringify(posEsquerda);

            var itemCima = '';
            var itemBaixo = '';
            var itemEsquerda = '';
            var itemDireita = '';

            if (posCima.y >= 0) {
                itemCima = tabuleiro.mapa[LARGURA_TABULEIRO * posCima.y + posCima.x];
            }
            if (posBaixo.y < ALTURA_TABULEIRO) {
                itemBaixo = tabuleiro.mapa[LARGURA_TABULEIRO * posBaixo.y + posBaixo.x];
            }
            if (posEsquerda.x >= 0) {
                itemEsquerda = tabuleiro.mapa[LARGURA_TABULEIRO * posEsquerda.y + posEsquerda.x];
            }
            if (posDireita.x < LARGURA_TABULEIRO) {
                itemDireita = tabuleiro.mapa[LARGURA_TABULEIRO * posDireita.y + posDireita.x];
            }

            info += " E = " + JSON.stringify({cima: itemCima, baixo: itemBaixo, esquerda: itemEsquerda, direita: itemDireita});

            return {cima: itemCima, baixo: itemBaixo, esquerda: itemEsquerda, direita: itemDireita};

        }

        function getItemTabuleiro(pos) {

            var xTabuleiro = parseInt(pos.x / TAMANHO_BLOCO);
            var yTabuleiro = parseInt(pos.y / TAMANHO_BLOCO);
            var itemTabuleiro = '';
            if (xTabuleiro > 0 && yTabuleiro > 0 && xTabuleiro < LARGURA_TABULEIRO && yTabuleiro < ALTURA_TABULEIRO) {
                var posTabuleiro = LARGURA_TABULEIRO * yTabuleiro + xTabuleiro;
                itemTabuleiro = tabuleiro.mapa[posTabuleiro];     
            }       
            return {x: xTabuleiro, y: yTabuleiro, item: itemTabuleiro};
        }

        function getPosCarroTabuleiro() {
            return {x: parseInt((carro.pos.x + TAMANHO_BLOCO / 2) / TAMANHO_BLOCO), y: parseInt((carro.pos.y + TAMANHO_BLOCO / 2) / TAMANHO_BLOCO)};
        }

        function getPosTabuleiro(x, y) {
            return {x: parseInt((x + TAMANHO_BLOCO / 2)/ TAMANHO_BLOCO), y: parseInt((y + TAMANHO_BLOCO / 2) / TAMANHO_BLOCO)};
        }

        function printInfo() {
            /**
            var posCarroTabuleiro = getPosCarroTabuleiro();

            var tabuleiroBaixo = getItemTabuleiro(getCarroPontoBaixo());
            var tabuleiroFrente = getItemTabuleiro(getCarroPontoFrente());
            var tabuleiroTraseira = getItemTabuleiro(getCarroPontoTraseira());
            var tabuleiroCima = getItemTabuleiro(getCarroPontoCima());

            var info = 'X = ' + carroX + 'Y = ' + carroY + '<br>';
            info += 'posCarroTabuleiro = ' + JSON.stringify(posCarroTabuleiro) + '<br>';
            info += 'tabuleiroBaixo = ' + JSON.stringify(tabuleiroBaixo) + '<br>';
            info += 'tabuleiroFrente = ' + JSON.stringify(tabuleiroFrente) + '<br>';
            info += 'tabuleiroTraseira = ' + JSON.stringify(tabuleiroTraseira) + '<br>';
            info += 'tabuleiroCima = ' + JSON.stringify(tabuleiroCima) + '<br>';
            info += 'tabuleiroCima = ' + JSON.stringify(tabuleiroCima) + '<br>';

            posCorona.forEach((item) => {
                if (posCarroTabuleiro.x == item.x && posCarroTabuleiro.y == item.y){
                    info += 'VIRUSSSSS ' + '<br>';
                }
            });

            info += 'temCorona = ' + temCorona() + '<br>';
            **/

            info += JSON.stringify(carro) + '<br>';
            info += 'Mudou: ' + carro.mudouDirecao() + '<br>';
            document.getElementById('info').innerHTML = info;
            info = '';
        }

        function pegouCorona() {

            var posCarroTabuleiro = getPosCarroTabuleiro();
            var resultado = false;
            posCorona.forEach((item) => {

                var posCoronaTabuleiro = getPosTabuleiro(item.pos.x, item.pos.y);
                if (posCarroTabuleiro.x == posCoronaTabuleiro.x && posCarroTabuleiro.y == posCoronaTabuleiro.y){
                    resultado = true;
                    return;
                }
            });
            
            return resultado;

        }

        function pegouVelhinho() {

            var resultado = null;
            if (!carro.pegouVelhinho) {

                var posCarroTabuleiro = getPosCarroTabuleiro();
                posVelhinho.forEach((item) => {

                    var posVelhinhoTabuleiro = getPosTabuleiro(item.pos.x, item.pos.y);
                    if (posCarroTabuleiro.x == posVelhinhoTabuleiro.x && posCarroTabuleiro.y == posVelhinhoTabuleiro.y){
                        resultado = item;
                        tocaMusica();
                        return;

                    }
                });

                carro.pegouVelhinho = (resultado != null);

            }

            return resultado;

        }

        // verifica se no entorno existe uma casa e se o carro esta com um velhinho
        // para ser devolvido
        function devolveuVelhinho() {
            // primeiro verifica se tem um velhinho
            if (carro.pegouVelhinho) {
                //obtem itens no entorno do carro (cima, baixo, esquerda e direita)
                var entorno = getItensEntorno(carro);
                var temCasa = (entorno.cima == 'casa' || entorno.direita == 'casa' || entorno.baixo == 'casa' || entorno.esquerda == 'casa');
                if (temCasa) {
                    carro.pegouVelhinho = false;
                    carro.pisca = 0;
                    pausaMusica();
                    if (carro.direcao == BOTAO_CIMA) {
                        carro.imagem = 'carrovc';
                    } else if (carro.direcao == BOTAO_DIREITA) {
                        carro.imagem = 'carrovd';
                    } else if (carro.direcao == BOTAO_BAIXO) {
                        carro.imagem = 'carrovb';
                    } else if (carro.direcao == BOTAO_ESQUERDA) {
                        carro.imagem = 'carrove';
                    }
                }

            }

        }

        function animacao() {

            window.setInterval(function(){
                animaCarro();
            }, 5);

        }

        function eventoTeclado(event) {

                if (carro.ultimaDirecao != carro.direcao) {
                    carro.ultimaDirecao = carro.direcao;
                }
                if (event.keyCode == BOTAO_BAIXO) {
                    carro.direcaoDesejada = BOTAO_BAIXO;
                } else if (event.keyCode == BOTAO_CIMA) {
                    carro.direcaoDesejada = BOTAO_CIMA;
                } else if (event.keyCode == BOTAO_ESQUERDA) {
                    carro.direcaoDesejada = BOTAO_ESQUERDA;
                } else if (event.keyCode == BOTAO_DIREITA) {
                    carro.direcaoDesejada = BOTAO_DIREITA;
                }

        }

        function splash() {

           var offCanvas = document.getElementById('tabuleiro');
           var ctxOffCanvas = offCanvas.getContext("2d");
            ctxOffCanvas.drawImage(imgBuffer.get('fundo'), 0, 0);

        }

        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function inicio(event) {
            var x = event.clientX;
            var y = event.clientY;

            getItensEntorno({pos:{x: event.clientX, y: event.clientY}});
            printInfo();
            if (x >= 360 && x <= 490 && y >= 370 && y <= 500) {
                exibeSplash = false;
                criaImagemFundo();
                animacao();
                this.sound = document.createElement("audio");
                this.sound.src = '01_loop_de_abertura.mp3';
                this.sound.setAttribute("preload", "auto");
                this.sound.setAttribute("controls", "none");
                this.sound.style.display = "none";
                document.body.appendChild(this.sound);

            }

        }

        function tocaMusica() {
            var promise = this.sound.play();
            promise.then((result)=>{
                console.log('Iniciada trillha!');
            }, (error)=>{console.log('Erro iniciar trilha: '+ error)});

        }

        function pausaMusica() {
            var promise = this.sound.pause();
            promise.then((result)=>{
                console.log('Parada trillha!');
            }, (error)=>{console.log('Erro parar trilha: '+ error)});

        }

        function removeElementoArray(array, indice) {
            var novoArray = [];
            for (var i = 0; i < array.length; i++) {
                if (i != indice) {
                    novoArray.push(array[i]);
                }
            }

            return novoArray;
        }

    </script>

</head>

<body onkeydown="eventoTeclado(event);" onclick="inicio(event)">

    <div>

        <canvas id="tabuleiro" style="border: solid 1px">
        </canvas>

    </div>

<div id="info"></div>
<div id="autormapa"></div>

<script>
        document.getElementById('tabuleiro').width = LARGURA_TABULEIRO * TAMANHO_BLOCO;
        document.getElementById('tabuleiro').height = ALTURA_TABULEIRO * TAMANHO_BLOCO;

        sorteiaTabuleiro();
        carregarBufferImagens(()=>{
            criaImagemFundo();
            splash();
            });

</script>

</body>
</html>