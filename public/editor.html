<html>

        <meta charset="UTF-8">

<head>
    <title>Corona Game - Editor</title>

    <script>

        const BOTAO_DIREITA = 39;
        const BOTAO_ESQUERDA = 37;
        const BOTAO_CIMA = 38;
        const BOTAO_BAIXO = 40;
        const ESPACO = 32;
        const TAMANHO_BLOCO = 64;
        const LARGURA_TABULEIRO = 19;
        const ALTURA_TABULEIRO = 9;

        var tabuleiro = [];

        var imagens = ['calcada', 'asfaltod', 'asfaltoe', 'asfaltoh', 'asfaltov', 'asfaltobd', 'asfaltobe', 'grama'];

        var imgBuffer = [];
        var cursorX = 0;
        var cursorY = 0;
        var imgCursor = null;
        var imgAtual = 0;
        var criarBloco = false;

        function carregarBufferImagens() {

            for (var i = 0; i < imagens.length; i++) {

                var img = new Image(); 
                img.src =  'img/' + imagens[i] + '.png'; 
                imgBuffer[i] = img;
                console.log('Carregado: ' + img.src);


            }

            imgCursor = new Image(); 
            imgCursor.src =  'img/cursor.png'; 

            console.log('Buffer de imagem carregado');

        }

        function initTabuleiro() {

            for (var i = 0; i < LARGURA_TABULEIRO * ALTURA_TABULEIRO; i++) {
                tabuleiro[i] = 'calcada';
            }

            console.log('Tabuleiro iniciado');
        }

        function desenhaTabuleiro() {

            var offCanvas = document.createElement('canvas');
            var ctxOffCanvas = offCanvas.getContext('2d');

            offCanvas.width = TAMANHO_BLOCO * LARGURA_TABULEIRO;
            offCanvas.height = TAMANHO_BLOCO * ALTURA_TABULEIRO;
            ctxOffCanvas.width = TAMANHO_BLOCO * LARGURA_TABULEIRO;
            ctxOffCanvas.height = TAMANHO_BLOCO * ALTURA_TABULEIRO;
            
            var linha = 0;
            var coluna = 0;

            for (var i = 0; i < tabuleiro.length; i++) {

                var img = imgBuffer[imagens.indexOf(tabuleiro[i])];
                ctxOffCanvas.drawImage(img, coluna, linha);
                coluna += TAMANHO_BLOCO;
                if (LARGURA_TABULEIRO == (coluna / TAMANHO_BLOCO)) {
                    coluna = 0;
                    linha += TAMANHO_BLOCO;
                }

            }
            
            if (criarBloco) {
                ctxOffCanvas.drawImage(imgBuffer[imgAtual], cursorX * TAMANHO_BLOCO, cursorY * TAMANHO_BLOCO);                    
            }

            ctxOffCanvas.drawImage(imgCursor, cursorX * TAMANHO_BLOCO, cursorY * TAMANHO_BLOCO);
            document.getElementById('tabuleiro').getContext("2d").drawImage(offCanvas, 0, 0);
            printInfo();

        }

        function getItemTabuleiro() {

            var posTabuleiro = LARGURA_TABULEIRO * cursorY + cursorX;
            return posTabuleiro;

        }

        function getPosCursorTabuleiro() {
            return {x: parseInt(cursorX / TAMANHO_BLOCO), y: parseInt(cursorY / TAMANHO_BLOCO)};
        }

        function printInfo() {

            var info = 'X = ' + cursorX + 'Y = ' + cursorY + '<br>';
            var tmp = 'var tabuleiro = [ ';
            for (var i = 0; i < tabuleiro.length; i++) {
                tmp += '"' + tabuleiro[i] + '"';
                if (i < (tabuleiro.length - 1)) {
                    tmp += ', ';
                    if (i % LARGURA_TABULEIRO == 0) {
                        tmp += '\n';
                    }
                }
            }
            info += tmp + ']';
            document.getElementById('info').innerHTML = info;

        }

        function atualizaCursor() {

        }

        function setBloco() {
            if (criarBloco) {
                    criarBloco = false;
                    var idx = getItemTabuleiro();
                    tabuleiro[idx] = imagens[imgAtual];
                    console.log(idx + " = " + tabuleiro[idx] );
                }
        }

        function eventoTeclado(event) {

            if (event.keyCode == BOTAO_BAIXO && cursorY < ALTURA_TABULEIRO - 1) {
                setBloco();
                cursorY++;
            } else if (event.keyCode == BOTAO_CIMA && cursorY > 0) {
                setBloco();
                cursorY--;
            } else if (event.keyCode == BOTAO_ESQUERDA && cursorX > 0) {
                setBloco();
                cursorX--;
            } else if (event.keyCode == BOTAO_DIREITA && cursorX < LARGURA_TABULEIRO - 1) {
                setBloco();
                cursorX++;
            } else if (event.keyCode == ESPACO) {
                imgAtual++;
                criarBloco = true;
                if (imgAtual > imagens.length) {
                    imgAtual = 0;
                }
            }

            desenhaTabuleiro();

        }

        function init() {

            document.getElementById('tabuleiro').width = LARGURA_TABULEIRO * TAMANHO_BLOCO;
            document.getElementById('tabuleiro').height = ALTURA_TABULEIRO * TAMANHO_BLOCO;
            carregarBufferImagens();
            initTabuleiro();
            desenhaTabuleiro();

 
        }
    </script>

</head>

<body onkeydown="eventoTeclado(event);" onload="init();">

    <div>

        <canvas id="tabuleiro"
        width="640" height="480"
        style="background: #ff0000">
        </canvas>

    </div>

<div id="info" style="height: 50px;overflow-y: auto"></div>
</body>
</html>